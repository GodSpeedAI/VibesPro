# =============================================================================
# Pre-commit Configuration for VibesPro
# =============================================================================
# Production-quality pre-commit hooks with proper environment handling.
#
# Key design decisions:
# 1. Remote repos for hermetic, reproducible checks (Python, Markdown, Shell)
# 2. Local wrapper script for Node.js tools (handles mise/fnm/nvm/devbox)
# 3. Fail-fast disabled to see all issues at once
# 4. Proper file filters to minimize unnecessary runs
# 5. Stages to group related checks
#
# Troubleshooting:
# - If Node.js hooks fail with "not found", run: mise install
# - To debug: PRECOMMIT_DEBUG=1 git commit -m "test"
# - To skip hooks: git commit --no-verify
#
# See: https://pre-commit.com
# =============================================================================

default_install_hook_types: [pre-commit, commit-msg]
default_stages: [pre-commit]

repos:
  # ===========================================================================
  # Stage 1: Quick sanity checks (fast, catch obvious issues early)
  # ===========================================================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
      # File hygiene
      - id: trailing-whitespace
        exclude: ^(.*\.md|.*\.j2|pnpm-lock\.yaml)$
      - id: end-of-file-fixer
        exclude: ^(.*\.j2|tests/fixtures/.*|pnpm-lock\.yaml)$
      - id: mixed-line-ending
        args: ['--fix=lf']
        exclude: ^(.*\.bat|.*\.ps1)$

      # Security checks
      - id: check-merge-conflict
      - id: detect-private-key
      - id: check-added-large-files
        args: ['--maxkb=1000']

      # Syntax validation
      - id: check-yaml
        exclude: ^(.*\.j2|pnpm-lock\.yaml|\.github/copilot-instructions\.md)$
        args: ['--unsafe'] # Allow custom tags
      - id: check-json
        exclude: ^(.*\.j2|tsconfig\..*\.json|templates/.*|.*\/\.devcontainer\/.*\.json)$
      - id: check-toml

      # Filesystem checks
      - id: check-case-conflict
      - id: check-symlinks
      - id: check-executables-have-shebangs
      - id: check-shebang-scripts-are-executable
        exclude: ^(.*\.rs|.*\.j2)$

  # ===========================================================================
  # Stage 2: Python linting and formatting (ruff - fast, all-in-one)
  # ===========================================================================
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.14.10
    hooks:
      - id: ruff
        name: ruff (lint)
        args: [--fix, --exit-non-zero-on-fix]
        exclude: ^(.*\.j2|tests/fixtures/.*|tools/type-generator/test-fixtures/.*|libs/tools/spec-kit/.*)$
      - id: ruff-format
        name: ruff (format)
        exclude: ^(.*\.j2|tests/fixtures/.*|libs/tools/spec-kit/.*)$

  # ===========================================================================
  # Stage 3: Python type checking (mypy - slower, but critical for type safety)
  # ===========================================================================
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.14.0
    hooks:
      - id: mypy
        name: mypy (type check)
        additional_dependencies:
          - types-PyYAML
          - types-requests
          - pydantic>=2.0
        args:
          - --strict
          - --python-version=3.12
          - --ignore-missing-imports
          - .
        pass_filenames: false
        exclude: |
          (?x)^(
            .*\.j2|
            tests/fixtures/.*|
            tests/.*|
            templates/.*|
            tmp/.*|
            hooks/.*|
            docs/knowledgebase/archive/.*|
            docs/update/.*|
            templates/tools/.*|
            tools/temporal-db/.*|
            tools/temporal_db/.*|
            scripts/.*|
            libs/shared/types-py/.*|
            libs/tools/spec-kit/.*|
            apps/smoke-test-service/.*|
            .*\{\{.*\}\}.*
          )$

  # ===========================================================================
  # Stage 4: Markdown linting
  # ===========================================================================
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: v0.43.0
    hooks:
      - id: markdownlint
        name: markdownlint
        args: ['--config', '.markdownlint.json', '--fix']
        exclude: ^(docs/knowledgebase/archive/.*|docs/update/.*|docs/wiki/.*|pnpm-lock\.yaml|libs/tools/spec-kit/.*)$

  # ===========================================================================
  # Stage 5: Shell script linting and formatting
  # ===========================================================================
  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.10.0.1
    hooks:
      - id: shellcheck
        name: shellcheck (lint)
        args: ['-S', 'warning', '-e', 'SC1091,SC2034'] # Relaxed for CI compatibility
        exclude: ^(.*\.j2|tests/fixtures/.*|templates/.*|libs/tools/spec-kit/.*)$

  # shfmt for formatting (local - requires shfmt installed)
  - repo: local
    hooks:
      - id: shfmt
        name: shfmt (format)
        entry: shfmt
        args: ['-i', '2', '-ci', '-w']
        language: system
        types: [shell]
        exclude: ^(.*\.j2|tests/fixtures/.*|libs/tools/spec-kit/.*)$

  # ===========================================================================
  # Stage 6: JavaScript/TypeScript (uses wrapper for mise/fnm/nvm support)
  # ===========================================================================
  - repo: local
    hooks:
      # Prettier for consistent formatting
      - id: prettier
        name: prettier (format)
        entry: ./scripts/hooks/precommit-node.sh prettier --write --ignore-unknown
        language: script
        types_or: [javascript, jsx, ts, tsx, json, yaml, markdown, css, scss]
        exclude: ^(pnpm-lock\.yaml|.*\.j2|tests/fixtures/.*|dist/.*|node_modules/.*|libs/tools/spec-kit/.*)$
        require_serial: false

      # ESLint for TypeScript linting
      - id: eslint
        name: eslint (lint)
        entry: ./scripts/hooks/precommit-node.sh eslint --fix --no-warn-ignored
        language: script
        types_or: [ts, tsx]
        exclude: ^(node_modules/|\.nx/|dist/|coverage/|.*\.j2|tests/fixtures/|tools/reference/|templates/|libs/tools/spec-kit/)
        require_serial: false

  # ===========================================================================
  # Stage 7: Custom project-specific hooks (non-blocking/informational)
  # ===========================================================================
  - repo: local
    hooks:
      # AGENTS.md link validation (non-blocking)
      - id: check-agent-links
        name: AGENTS.md links (non-blocking)
        entry: ./scripts/hooks/precommit-node.sh node tools/docs/link_check.js
        language: script
        files: ^AGENTS\.md$
        pass_filenames: false
        verbose: true
        # Non-blocking: always succeeds but shows warnings
        # Remove || true to make it blocking
        stages: [manual]

      # Prompt file linting (optional - enable when prompt files are stable)
      - id: prompt-lint
        name: prompt-lint (non-blocking)
        entry: ./scripts/hooks/precommit-node.sh node tools/prompt/lint.js
        language: script
        files: ^\.github/prompts/.*\.prompt\.md$
        stages: [manual]

      # Spec matrix validation (optional - enable when spec tooling is stable)
      - id: spec-matrix
        name: spec-matrix (non-blocking)
        entry: ./scripts/hooks/precommit-node.sh node tools/spec/matrix.js
        language: script
        files: ^(docs/.*\.md|\.github/instructions/.*\.md)$
        pass_filenames: false
        stages: [manual]

# =============================================================================
# Configuration
# =============================================================================
fail_fast: false
minimum_pre_commit_version: '3.0.0'

# CI configuration - skip hooks that require local toolchain
ci:
  skip:
    - shfmt # Requires local shfmt installation
    - prettier # CI runs these via dedicated workflow
    - eslint # CI runs these via dedicated workflow
  autoupdate_schedule: monthly
  autoupdate_commit_msg: 'chore(deps): update pre-commit hooks'
