---
document_type: SEA_DSL_TOOL_IN_LOOP_REFERENCE
version: '1.0'
description: >
  Make the agent converge to "expert-correct" SEA-DSL by forcing a deterministic loop:
  (draft -> format -> validate -> project -> re-validate outputs if applicable).
  This is the reliability layer that prevents hallucination from surviving.

binaries:
  cli_name: sea
  crate: sea-core
  build_paths:
    note: 'Prefer an installed/packaged binary if your repo provides it. Otherwise build from workspace:'
    cargo_build:
      command: 'cargo build -p sea-core --features cli'
      expected_binary: 'target/debug/sea'
    cargo_run:
      command_template: 'cargo run -p sea-core --features cli -- <ARGS>'

execution_contract:
  non_negotiables:
    - 'Never claim success without running `sea validate` (or receiving its output).'
    - 'On any error: read the diagnostic text, apply the smallest possible fix, re-run.'
    - 'Do not change model intent while fixing syntax/validation (only fix errors).'
    - 'Prefer edits that preserve names and IDs (avoid churn).'

loop:
  steps:
    - id: S1_draft
      action: 'Write/modify SEA-DSL in a .sea file.'
      success_signal: 'File contains only SEA-DSL text; no pseudo-code.'

    - id: S2_format
      action: 'Normalize formatting before validation to reduce noisy diffs.'
      command:
        primary: 'sea format <FILE_OR_DIR>'
        alt_run: 'cargo run -p sea-core --features cli -- format <FILE_OR_DIR>'
      success_signal: 'Command exits 0; file diff is mostly whitespace/ordering.'
      failure_modes:
        - symptom: 'format subcommand not found'
          fix: 'Ensure you built with --features cli and are running the correct binary.'

    - id: S3_validate
      action: 'Parse + semantic validation gate (must be clean).'
      command:
        primary: 'sea validate <FILE_OR_DIR>'
        options:
          format: '--format human|json|lsp'
          no_color: '--no-color'
          show_source: '--show-source'
        alt_run: 'cargo run -p sea-core --features cli -- validate <FILE_OR_DIR>'
      success_signal: "Exit 0; 'no errors' (or equivalent) and no diagnostics emitted."
      failure_signal: 'Non-zero exit; diagnostics list parse/validation errors.'

    - id: S4_project
      action: 'Prove interoperability by projecting to at least one downstream format.'
      command:
        primary: 'sea project --format <FORMAT> <INPUT_FILE_OR_DIR> <OUTPUT_PATH>'
        options:
          namespace_filter: '--namespace "<namespace>"'
          protobuf:
            package: '--package "sea.generated"'
            include_governance: '--include-governance'
            include_services: '--include-services'
            compatibility: '--compatibility additive|backward|breaking'
            schema_history: '--schema-history <DIR>'
            apply_fixes: '--apply-fixes'
            buf_lint: '--buf-lint'
            buf_breaking: '--buf-breaking'
            buf_generate: '--buf-generate'
            multi_file: '--multi-file'
        formats:
          - calm
          - kg
          - sbvr
          - protobuf
          - proto
        alt_run: 'cargo run -p sea-core --features cli -- project --format <FORMAT> <INPUT> <OUTPUT>'
      success_signal: "Exit 0 and prints a 'Projected to ...' success message; output file(s) exist."
      failure_modes:
        - symptom: 'Projection succeeds but output is empty/trivial'
          fix: 'Check namespace filter; remove --namespace or correct @namespace values.'
        - symptom: 'protobuf projection errors mentioning compatibility/buf'
          fix: 'Disable buf** flags first; then re-enable one by one after baseline success.'

    - id: S5_regression_gate
      action: 'Re-run validation after edits and keep a minimal diff.'
      command:
        primary: 'sea validate <FILE_OR_DIR>'
      success_signal: 'Still clean after projection-related refactors.'

diagnostics_playbook:
  categories:
    parse_errors:
      meaning: 'Grammar violation (tokens/ordering/structure).'
      fix_strategy_order:
        - 'Check declaration keyword spelling (case-insensitive but must exist).'
        - 'Check punctuation: braces {}, commas, colons in relation/policy blocks.'
        - 'Ensure strings are quoted with double-quotes.'
        - 'Ensure identifiers (policy/instance ids) are unquoted and match [A-Za-z_][A-Za-z0-9_]*.'
      common_symptoms:
        - "Unexpected token near ':' or '}'"
        - 'Failed to parse'

    semantic_validation_errors:
      meaning: 'Parses, but violates model rules (unbound vars, missing concepts, collisions).'
      fix_strategy_order:
        - 'Bind variables in expressions with forall/exists (no free identifiers).'
        - 'Replace free instance refs with @<instance_id> or quantify over instances.'
        - 'Add explicit domains/scopes (in <domain>, <unit> in <domain>) to remove collisions.'
        - 'Define Dimension/Unit before using quantity literals that assume them.'
      common_symptoms:
        - 'Unknown identifier in expression'
        - 'Unbound variable'
        - 'Ambiguous concept name'

    projection_errors:
      meaning: 'Model is valid, but export constraints fail (format-specific).'
      fix_strategy_order:
        - 'Project without namespace filter first.'
        - 'Project to calm/kg first (usually simpler) before protobuf.'
        - 'For protobuf: start with --compatibility backward and no buf** flags.'
        - 'Enable buf_lint, buf_breaking, buf_generate only after clean baseline.'
      common_symptoms:
        - 'Failed to serialize'
        - 'Failed to convert to Knowledge Graph'
        - 'buf lint/breaking failed'

minimal_fix_rules:
  preserve_intent:
    - 'Do not rename concepts unless the error explicitly requires it.'
    - 'Prefer adding scope (in <domain>) over renaming.'
    - 'Prefer binding/qualifying variables over rewriting the whole expression.'
  diff_hygiene:
    - 'One error category per edit cycle.'
    - 'Keep edits localized to the failing declaration/expression.'

agent_operating_mode:
  required_outputs_per_cycle:
    - 'Current file excerpt (only the relevant lines).'
    - 'Exact command run.'
    - 'Exact diagnostic text (or confirmation of exit 0).'
    - 'Patch-style diff of changes applied.'
  stop_conditions:
    - 'Validation clean AND at least one projection clean.'
    - 'If user requested a specific format (e.g., protobuf), stop only after that projection succeeds.'

quickstart_examples:
  validate_file:
    command: 'sea validate ./models/payment.sea'

  validate_dir:
    command: 'sea validate ./models'

  project_calm:
    command: 'sea project --format calm ./models/payment.sea ./out/payment.calm.json'

  project_kg_rdf:
    command: 'sea project --format kg ./models/payment.sea ./out/payment.rdf'

  project_proto_baseline:
    command: 'sea project --format proto ./models/payment.sea ./out/payment.proto'

  project_protobuf_with_checks:
    command: >
      sea project --format protobuf --compatibility backward --schema-history ./schema_history
      --buf-lint --buf-breaking --buf-generate
      ./models ./out/generated
---
