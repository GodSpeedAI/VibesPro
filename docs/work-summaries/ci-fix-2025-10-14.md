CI Fix Work Summary — 2025-10-14

## Summary

I fixed GitHub Actions workflow and script issues that were preventing CI validation from completing for the branch `codex/explore-ai-enhancement-strategies-61apuy`.

## What changed

- Workflows

  - `.github/workflows/build-matrix.yml`
    - Replaced compile-time secret interpolation/use in `if:` conditions with runtime checks inside `run:` steps that read the environment variable (e.g., check `$SOPS_AGE_KEY`).
    - Ensured secret decryption steps only run when the secret and encrypted file exist.
    - Updated enforcement step to check `$REQUIRE_SOPS_SECRETS` at runtime.
  - `.github/workflows/env-check.yml`
    - Moved secrets checks into `run:` steps and used `$SOPS_AGE_KEY` runtime checks rather than expressions the static analyzer flagged.
  - `.github/workflows/semgrep.yml`
    - Removed job-level secret-to-env mapping and left a comment to access secrets from steps. This avoids the static analyzer complaint.

- Scripts
  - `scripts/normalize_chatmodes.js` — removed unused `rest` assignment and clarified trailing handling.
  - `scripts/normalize_chatmodes.mjs` — removed unused `orig` assignment and simplified trailing fence stripping.

## Verification performed locally

- Repo static checks: `get_errors` → No errors found
- Fast test runner: `runTests` → 4 passed, 0 failed
- Created and pushed commit to branch `codex/explore-ai-enhancement-strategies-61apuy`:
  - Commit: `fix(ci): avoid secret interpolation in workflows; fix script lint errors [DEV-PRD-031]` (hash available on remote)

## Notes / rationale

- Some YAML/static analyzers flag expressions that reference `secrets` or interpolate secrets inside `if:` conditions during static validation. GitHub Actions allows runtime secrets in steps; to satisfy the validators and keep the behavior correct, I moved secret-dependent conditionals into shell `run:` steps that check environment variables such as `$SOPS_AGE_KEY`.
- This preserves the original intent (decrypt secrets when provided) while preventing compile-time validation errors.

## Next steps (recommended)

1. Let GitHub Actions run on the pushed branch — this validates the end-to-end behavior (runner tools, caching, and secrets).
2. If a workflow fails on GitHub, attach the specific job log here and I will iterate rapidly to fix the failure.
3. Optionally run a broader local validation:

```bash
# optional: run larger validation locally
pnpm install --frozen-lockfile
pnpm test  # or pnpm test:jest
uv sync --frozen  # python deps
uv run pytest
cargo test --manifest-path crates/vibepro-observe/Cargo.toml
```

If you want me to post a PR comment or update the PR description, provide the PR URL or confirm and I will do that next.

Signed-off-by: automated assistant
