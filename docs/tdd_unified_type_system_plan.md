# TDD Plan: Unified Type System Implementation

This document outlines the phased, parallelizable TDD implementation plan for the Unified Type System, as specified in `e2e_types_spec.md` and detailed in the supporting ADRs, PRDs, and SDSs.

**Note:** All work described in this plan is to be performed on the template project located in the `templates/{{project_slug}}` directory. The goal is to produce a fully-featured, reusable project template.

The work is broken down into three phases, with each phase containing tasks that can be executed in parallel by up to three autonomous agents. Each task represents a complete TDD cycle: **RED** -> **GREEN** -> **REFACTOR** -> **REGRESSION**.

## Phase 1: Foundation & Tooling

**Goal:** Establish the core infrastructure, database schema, type generation pipeline, and scaffolding generators.

| Agent                     | Task ID      | Task Description                       | TDD Cycle                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | Key Artifacts & References                                                                                                                                |
| :------------------------ | :----------- | :------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Agent 1 (Database)**    | `P1-A1-DB`   | **Setup Supabase & Initial Schema**    | **RED:** Write a test that fails to connect to a local Supabase instance. <br/> **GREEN:** Initialize Supabase (`supabase/`), create a `docker-compose.yml` for local dev, and get the test to connect. <br/> **REFACTOR:** Organize Supabase config. <br/> **REGRESSION:** Write a test for the `users` table migration (`DEV-SDS-019`). Create the migration file; write a script to apply it and verify the table exists.                                                                                | `supabase/migrations/`, `docker-compose.yml`, `justfile` (`db-start`, `db-migrate`), `tests/db/test_migrations.sh`, [DEV-SDS-019](dev_sds.md#dev-sds-019) |
| **Agent 2 (Tooling)**     | `P1-A2-PIPE` | **Implement Type Generation Pipeline** | **RED:** Write a test that checks for the existence of `libs/shared/types/src/database.types.ts` and fails. <br/> **GREEN:** Create a `just gen-types-ts` command that runs the Supabase CLI to generate the TS types file. <br/> **REFACTOR:** Add error handling and logging. <br/> **REGRESSION:** Write a test for Python type generation (`DEV-SDS-020`). Implement `just gen-types-py` and the top-level `just gen-types`.                                                                            | `justfile`, `libs/shared/types/`, `tools/scripts/gen_py_types.py`, `tests/tooling/test_type_gen.sh`, [DEV-SDS-020](dev_sds.md#dev-sds-020)                |
| **Agent 3 (Scaffolding)** | `P1-A3-GEN`  | **Create Core Nx Domain Generator**    | **RED:** Write a failing Nx generator unit test that expects a set of domain libraries to be created. <br/> **GREEN:** Implement the `@vibepro/domain` generator to orchestrate library creation. It should correctly call `@nxlv/python` for the `api` layer and prepare the `ui` layer for use with `@nx-extend/shadcn-ui`. <br/> **REFACTOR:** Clean up generator code and templates. <br/> **REGRESSION:** Add tests to verify the generator creates all required layers and correctly applies Nx tags. | `tools/generators/domain/`, `tests/generators/domain.spec.ts`, [DEV-SDS-021](dev_sds.md#dev-sds-021), [DEV-ADR-021](dev_adr.md#dev-adr-021)               |

---

## Phase 2: Backend Implementation (Domain: `auth`)

**Goal:** Build a fully functional, type-safe FastAPI backend for the `auth` domain using the Ports & Adapters pattern.

| Agent                      | Task ID       | Task Description                                      | TDD Cycle                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | Key Artifacts & References                                                                               |
| :------------------------- | :------------ | :---------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------- |
| **Agent 1 (Domain Logic)** | `P2-A1-LOGIC` | **Implement Auth Domain, Ports, & Application Logic** | **RED:** Write failing unit tests for an `AuthService` that uses a mocked `IUserRepository` port. <br/> **GREEN:** Run `nx g @vibepro/domain auth`. Define the `IUserRepository` port in `libs/auth/application/ports`. Implement the `AuthService` in `libs/auth/application` to use this port via dependency injection. <br/> **REFACTOR:** Improve domain model logic and port interfaces. <br/> **REGRESSION:** Add tests for password hashing and business rule validation.                                              | `libs/auth/domain/`, `libs/auth/application/ports/`, `libs/auth/application/`, `tests/auth/application/` |
| **Agent 2 (API & Data)**   | `P2-A2-DATA`  | **Implement Auth Infrastructure (Adapters) & API**    | **RED:** Write failing integration tests for a `SupabaseUserRepository` adapter that can't create or find users. <br/> **GREEN:** Implement the `SupabaseUserRepository` in `libs/auth/infrastructure/adapters`, ensuring it implements the `IUserRepository` port. <br/> **REFACTOR:** Abstract data access patterns within the adapter. <br/> **REGRESSION:** Write failing e2e tests for the `/register` FastAPI endpoint. Implement the API (driving adapter) in `libs/auth/api` that injects and uses the `AuthService`. | `libs/auth/infrastructure/adapters/`, `libs/auth/api/`, `tests/auth/infrastructure/`, `tests/auth/api/`  |
| **Agent 3 (Validation)**   | `P2-A3-VALID` | **CI & Validation for Backend**                       | **RED:** Create a CI workflow that runs backend tests and fails. <br/> **GREEN:** Implement the necessary `just` commands (`test-backend`, `lint-backend`) and configure the CI workflow to run them successfully. <br/> **REFACTOR:** Optimize CI steps for speed. <br/> **REGRESSION:** Add a CI step that runs `just gen-types` and fails if the generated files have changed, ensuring types are always committed.                                                                                                        | `.github/workflows/backend-ci.yml`, `justfile`, [DEV-SDS-020](dev_sds.md#dev-sds-020)                    |

---

## Phase 3: Frontend Implementation (Domain: `auth`)

**Goal:** Build a type-safe UI for the `auth` domain that consumes the backend API, supporting the configured frontend framework.

| Agent                       | Task ID       | Task Description                                          | TDD Cycle                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | Key Artifacts & References                                                      |
| :-------------------------- | :------------ | :-------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------ |
| **Agent 1 (App Setup)**     | `P3-A1-APP`   | **Scaffold Frontend App (Next.js/Remix/Expo)**            | **RED:** Write a test that fails to build the chosen frontend application. <br/> **GREEN:** Create a new frontend app in `apps/<app_name>` using the appropriate generator (`@nx/next`, `@nx/remix`, or `@nx/expo`) based on the `app_framework` value in `copier.yml`. Configure `tsconfig.json` to resolve shared types. <br/> **REFACTOR:** Set up base styles and layout. <br/> **REGRESSION:** Write a test to ensure the generated `User` type can be imported and used within a component.              | `apps/<app_name>/`, `copier.yml`, `tests/frontend/setup.spec.ts`                |
| **Agent 2 (UI Components)** | `P3-A2-UI`    | **Implement Type-Safe Registration Form using Shadcn UI** | **RED:** Write a failing component test for a `RegistrationForm`. <br/> **GREEN:** Use the `@nx-extend/shadcn-ui` generator to scaffold the necessary form components (`Input`, `Button`, `Form`) into `libs/auth/ui`. Build the `RegistrationForm` using these components and connect it to the generated types for state and validation. <br/> **REFACTOR:** Improve component structure and API hook. <br/> **REGRESSION:** Write a Playwright e2e test that submits the form and verifies the UI response. | `libs/auth/ui/`, `apps/<app_name>/`, `tests/auth/ui/`, `tests/e2e/auth.spec.ts` |
| **Agent 3 (Validation)**    | `P3-A3-VALID` | **CI & Validation for Frontend**                          | **RED:** Create a CI workflow that runs frontend tests and fails. <br/> **GREEN:** Implement `just` commands (`test-frontend`, `lint-frontend`, `test-e2e`) and configure the CI workflow. <br/> **REFACTOR:** Optimize frontend build and test steps in CI. <br/> **REGRESSION:** Add a step to the main CI pipeline that runs `nx affected:test` to ensure PRs only run tests for affected projects.                                                                                                         | `.github/workflows/frontend-ci.yml`, `justfile`, `nx.json`                      |
