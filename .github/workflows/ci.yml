name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      LC_ALL: C.UTF-8
      LANG: C.UTF-8
      NX_NO_CLOUD: "true"
      NX_REJECT_REMOTE_CACHE: "true"

    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Load versions
        run: cat .github/config/versions.env >> $GITHUB_ENV

      - name: Setup pnpm
        uses: pnpm/action-setup@a3252b78c470c02df07e9d59298aecedc3ccdd6d # v3.0.0
        with:
          run_install: false

      - name: Set up Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: "20.11.1"
          cache: "pnpm"

      - name: Set up Python
        uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38 # v5.4.0
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@6dfebec6ddbcd197e02256fbdf54deb334fb7f06 # v2

      - name: Install Bun runtime
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.1.42"

      - name: Install Copier
        run: uv tool install copier

      - name: Install just
        shell: bash
        run: |
          if command -v just >/dev/null 2>&1; then
            echo "just already installed"
            just --version
          else
            curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to ~/.local/bin
            echo "$HOME/.local/bin" >> $GITHUB_PATH
          fi

      - name: Verify just installation
        run: just --version

      - name: Setup Devbox (CI)
        uses: ./.github/actions/setup-devbox

      - name: "Devbox: update and ensure packages"
        run: |
          set -euo pipefail
          # Update generated flake to ensure packages are available in the shell
          devbox update || true

      - name: "Devbox: validate overlay pin (supabase)"
        run: |
          set -euo pipefail
          bash scripts/dev/validate_supabase_overlay_pin.sh

      - name: "Devbox: check supabase availability"
        run: |
          set -euo pipefail
          bash scripts/dev/check_supabase_in_devbox.sh

      - name: Install Node dependencies
        run: pnpm install --frozen-lockfile

      - name: TypeScript typecheck
        # Run tsc explicitly (non-pretty) to surface compiler errors with clear diagnostics
        run: pnpm exec tsc --noEmit --pretty false || { echo "::error::TypeScript typecheck failed"; exit 1; }

      - name: Install Python dependencies
        run: uv sync --group dev --all-extras --frozen

      - name: Build projects
        run: pnpm build

      - name: Lint
        run: |
          pnpm lint
          uv run ruff check .

      - name: Run tests
        run: |
          echo "Running Jest tests..."
          pnpm test:jest --runInBand --passWithNoTests || { echo "::error::Jest tests failed"; exit 1; }
          echo "Running targeted AI guidance Jest suites..."
          pnpm test:jest -- --runTestsByPath tests/perf/test_performance_advisories.spec.ts tests/context/test_context_manager_scoring.spec.ts --runInBand || { echo "::error::AI guidance Jest suites failed"; exit 1; }
          echo "Running Node smoke tests..."
          pnpm test:node || { echo "::error::Node smoke tests failed"; exit 1; }
          echo "Running pytest..."
          uv run pytest || { echo "::error::Pytest failed"; exit 1; }
          echo "All tests passed successfully!"

      - name: Validate template
        # UV_NO_SYNC=1 prevents uv from syncing dependencies during template generation test
        # This validates that the template generation process works correctly
        run: |
          set -e
          just test-generation || {
            echo "::error::Template generation validation failed. Check 'just test-generation' output above."
            exit 1
          }
        env:
          UV_NO_SYNC: "1"
