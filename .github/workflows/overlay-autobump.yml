name: devbox-overlay-autobump

on:
  # Run on a schedule (daily at 03:00 UTC) and allow manual dispatch
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  autobump:
    runs-on: ubuntu-latest
    env:
      LC_ALL: C.UTF-8
      LANG: C.UTF-8
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Load versions
        run: cat .github/config/versions.env >> $GITHUB_ENV

      - name: Install system packages (jq, curl)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends jq curl git

      - name: Setup Devbox
        uses: ./.github/actions/setup-devbox

      - name: Setup mise
        uses: ./.github/actions/setup-mise

      - name: Set up Git user
        run: |
          git config user.name "autobump[bot]"
          git config user.email "autobump@github.com"

      - name: Run overlay autobump script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          bash scripts/ci/devbox_overlay_autobump.sh

      - name: Read PR number generated by script
        id: read_pr
        run: |
          if [ -f .autobump_pr_number ]; then cat .autobump_pr_number; else echo 'PR_NUMBER='; fi

      - name: Attempt auto-merge when checks pass
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const core = require('@actions/core');
            const prFile = '.autobump_pr_number';
            if (!fs.existsSync(prFile)) {
              core.info('PR number file missing; skipping auto-merge');
              return;
            }
            const content = fs.readFileSync(prFile, 'utf8').trim();
            const prNumber = content.split('=')[1];
            if (!prNumber) { core.info('PR number couldn't be read'); return; }

            const owner = context.repo.owner; const repo = context.repo.repo;
            core.info(`Checking PR #${prNumber}`);
            // Poll for a period of time for required status checks to complete successfully
            const requiredChecks = ['ci', 'env-check'];
            const maxAttempts = 30;
            const delayMs = 60 * 1000; // 60s between checks

            for (let i=0; i<maxAttempts; i++) {
              const { data: pr } = await github.rest.pulls.get({ owner, repo, pull_number: prNumber });
              // Use commit SHA for statuses
              const headSha = pr.head.sha;
              const { data: combined } = await github.rest.repos.getCombinedStatusForRef({ owner, repo, ref: headSha });
              const statuses = combined.statuses.map(s => ({ context: s.context, state: s.state }));
              core.info(`Attempt ${i+1}: statuses: ${JSON.stringify(statuses)}`);
              const allOk = requiredChecks.every(rc => statuses.find(s => s.context.includes(rc) && s.state === 'success'));
              if (allOk && pr.mergeable_state === 'clean') {
                core.info('All required checks are green, attempting to merge PR');
                await github.rest.pulls.merge({ owner, repo, pull_number: prNumber, merge_method: 'squash' });
                core.info('PR merged');
                return;
              }
              core.info('Not ready yet, sleeping...');
              await new Promise(r => setTimeout(r, delayMs));
            }
            core.info('Timed out waiting for checks or mergeable state - leaving PR open');
