name: Decrypt secrets and test

on:
  push:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: sops-decrypt-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1

      - name: Setup SOPS with decryption
        id: sops
        uses: ./.github/actions/setup-sops
        with:
          sops-age-key: ${{ secrets.SOPS_AGE_KEY }}

      - name: Run tests
        run: |
          # Load secrets if decrypted
          if [ "${{ steps.sops.outputs.sops-loaded }}" = "true" ]; then
            set -a
            # shellcheck disable=SC1091
            source "${{ steps.sops.outputs.decrypted-file }}" || { echo "::error:: Failed to source secrets"; exit 1; }
            set +a
            echo "Running tests with decrypted secrets..."
          else
            echo "No secrets available; running tests without them..."
          fi
          # Add actual test commands here
          echo "Tests completed successfully"

      - name: Cleanup
        if: always()
        run: |
          if [ -f "${{ steps.sops.outputs.decrypted-file }}" ]; then
            shred -u "${{ steps.sops.outputs.decrypted-file }}" 2>/dev/null || rm -f "${{ steps.sops.outputs.decrypted-file }}"
          fi
          if [ -f "$HOME/.config/sops/age-key.txt" ]; then
            shred -u "$HOME/.config/sops/age-key.txt" 2>/dev/null || rm -f "$HOME/.config/sops/age-key.txt"
          fi
