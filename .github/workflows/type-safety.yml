name: Type Safety CI
permissions:
  contents: read

on:
  pull_request:
    branches: [main, dev]
  push:
    branches: [main, dev]
  workflow_dispatch:

jobs:
  typescript-check:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run TypeScript Compiler Check
        run: |
          # Run tsc and capture errors to a file so the summary step can show them clearly
          pnpm exec tsc --noEmit --project tsconfig.json 2> .github/tsc-errors.txt || (
            echo "❌ TypeScript compilation failed — errors below:";
            cat .github/tsc-errors.txt;
            exit 1
          )

      - name: Run ESLint with Type Checking
        run: pnpm exec eslint tools tests --ext .ts --max-warnings 0

  python-type-check:
    name: Python Type Check (mypy)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev]"

      - name: Run mypy strict check with report
        run: |
          # Run mypy and capture stderr to a file so failures are clearly printed in the logs
          python -m mypy --strict --any-exprs-report=mypy-report libs/python 2> .github/mypy-errors.txt || (
            echo "❌ mypy type checking failed — errors below:";
            cat .github/mypy-errors.txt;
            exit 1
          )

      - name: Print mypy coverage summary
        if: always()
        run: |
          if [ -f mypy-report/index.txt ]; then
            cat mypy-report/index.txt
          fi

  supabase-integration:
    name: Supabase Schema & Type Generation
    runs-on: ubuntu-latest
    needs: [typescript-check, python-type-check]
    services:
      # Use Docker Compose instead of service container for full Supabase stack
      postgres:
        image: supabase/postgres:15.1.0.117
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 54322:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile
          python -m pip install --upgrade pip pydantic

      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 54322 -U postgres; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
          echo "✅ PostgreSQL is ready"

      - name: Apply database migrations
        run: |
          for f in supabase/migrations/*.sql; do
            if [ -f "$f" ]; then
              echo "Applying: $(basename $f)"
              PGPASSWORD=postgres psql -h localhost -p 54322 -U postgres -d postgres -f "$f" -q
            fi
          done
          echo "✅ Migrations applied"

      - name: Generate TypeScript types from database
        run: |
          python3 tools/scripts/gen_ts_from_pg.py \
            --host localhost \
            --port 54322 \
            --output /tmp/generated-database.types.ts

      - name: Compare generated TypeScript types
        run: |
          if ! diff -u libs/shared/types/src/database.types.ts /tmp/generated-database.types.ts; then
            echo ""
            echo "❌ Generated TypeScript types differ from committed file."
            echo ""
            echo "The database schema has changed but types were not regenerated."
            echo "To fix, run locally:"
            echo "  just supabase-start"
            echo "  just db-migrate"
            echo "  just gen-types"
            echo ""
            echo "Then commit the updated type files."
            exit 1
          fi
          echo "✅ TypeScript types match database schema"

      - name: Generate Python models
        run: |
          python3 tools/scripts/gen_py_types.py libs/shared/types/src /tmp/py-types

      - name: Compare generated Python models
        run: |
          if ! diff -u libs/shared/types-py/src/models.py /tmp/py-types/models.py; then
            echo ""
            echo "❌ Generated Python models differ from committed file."
            echo ""
            echo "Run 'just gen-types' locally and commit the changes."
            exit 1
          fi
          echo "✅ Python models are up to date"

      - name: Run type safety tests
        run: |
          pnpm exec jest tests/integration/supabase/type-safety-pipeline.test.ts --runInBand

  type-safety-summary:
    name: Type Safety Summary
    needs: [typescript-check, python-type-check, supabase-integration]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check Results
        run: |
          if [ "${{ needs.typescript-check.result }}" == "failure" ] || \
             [ "${{ needs.python-type-check.result }}" == "failure" ] || \
             [ "${{ needs.supabase-integration.result }}" == "failure" ]; then
            echo "❌ Type safety checks failed"
            exit 1
          else
            echo "✅ All type safety checks passed"
          fi
