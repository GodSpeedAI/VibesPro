import { existsSync, readFileSync } from 'node:fs';
import { join } from 'node:path';

/**
 * Load resolved tech stack JSON produced by translator.py.
 * - Default path: {{ project_slug }}/tools/transformers/.derived/techstack.resolved.json
 * - Override via env: VIBEPDK_TECHSTACK_RESOLVED
 */
export function loadResolvedStack(root: string): unknown | null {
    const override = process.env.VIBEPDK_TECHSTACK_RESOLVED;
    const p = override || join(root, '{{ project_slug }}', 'tools', 'transformers', '.derived', 'techstack.resolved.json');
    if (!existsSync(p)) return null;
    try {
        const txt = readFileSync(p, 'utf8');
        return JSON.parse(txt);
    } catch (_e) {
        return null;
    }
}

/** Get a simple helper to fetch a category subtree safely. */
export function getCategory(stack: unknown | null, name: string): unknown | null {
    if (!stack || typeof stack !== 'object') return null;
    const stackRec = stack as Record<string, unknown>;
    const cats = stackRec['categories'];
    if (!cats || typeof cats !== 'object') return null;
    const catsRec = cats as Record<string, unknown>;
    return (catsRec[name] as unknown) ?? null;
}
