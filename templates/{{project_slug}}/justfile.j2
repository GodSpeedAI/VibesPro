set shell := ["bash", "-uc"]

# Auto-detect build strategy
default: (_detect_build_system)

# Build all projects
build:
    @echo "Building {{ project_name }}..."
    {% if architecture_style == "hexagonal" %}
    pnpm nx run-many --target=build --all --parallel=3
    {% else %}
    pnpm build
    {% endif %}

# Test all projects
test:
    @echo "Testing {{ project_name }}..."
    @if [ -f "nx.json" ]; then \
        pnpm nx run-many --target=test --all --parallel=3; \
    else \
        pnpm test --if-present; \
    fi

# Lint all projects
lint:
    @echo "Linting {{ project_name }}..."
    @if [ -f "nx.json" ]; then \
        pnpm nx run-many --target=lint --all; \
    else \
        pnpm lint --if-present; \
    fi

# Development server
dev:
    @echo "Starting development server for {{ project_name }}..."
    @if [ -f "nx.json" ]; then \
        pnpm nx run-many --target=serve --all --parallel=5; \
    else \
        pnpm dev --if-present || pnpm start --if-present; \
    fi

spec-matrix:
    pnpm spec:matrix

prompt-lint:
    pnpm prompt:lint

# Setup project
setup:
    @echo "Setting up {{ project_name }}..."
    pnpm install
    {% if include_ai_workflows %}
    just setup-ai
    {% endif %}

{% if include_ai_workflows %}
# Setup AI workflows
setup-ai:
    @echo "Setting up AI workflows..."
    python tools/temporal-db/init.py

# Initialize temporal database
db-init:
    python tools/temporal-db/init.py

# Backup temporal database
db-backup:
    python tools/temporal-db/backup.py

# Customize copilot instructions interactively
customize-instructions:
    @echo "ðŸ¤– Interactive Copilot Instructions Customization"
    @echo "=================================================="
    @echo ""
    @echo "This will guide you through customizing .github/copilot-instructions.md"
    @echo "for your project. Answer questions about your:"
    @echo "  - Project type and tech stack"
    @echo "  - Architecture and domain"
    @echo "  - Team size and development practices"
    @echo "  - Testing, security, and deployment approaches"
    @echo ""
    @echo "You can also use the 'meta.customize-instructions' chat mode in VS Code."
    @echo ""
    @read -p "Press Enter to start the interactive customization..."
    @echo ""
    @echo "Opening .github/prompts/customize.copilot-instructions.prompt.md..."
    @echo "Please use this prompt in your AI chat (GitHub Copilot or VS Code chat)."
    @echo ""
    @cat .github/prompts/customize.copilot-instructions.prompt.md
{% endif %}

_detect_build_system:
   #!/usr/bin/env bash
   if [ -f "nx.json" ]; then
      just build
   else
      pnpm build
   fi
